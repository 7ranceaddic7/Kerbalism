<?xml version="1.0" encoding="utf-8"?>

<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
	  <!-- Global config for all projects -->
	  <TargetFrameworkVersion>v3.5</TargetFrameworkVersion>
	  <PlatformTarget>x64</PlatformTarget>
	  <!-- Build paths -->
    <KerbalismBuildPath Condition="$(Configuration)==Debug" >..\..\buildscripts\BuildDebug</KerbalismBuildPath>
	  <KerbalismBuildPath Condition="$(Configuration)==Release" >..\..\buildscripts\BuildRelease</KerbalismBuildPath>
    <OutputPath>$(KerbalismBuildPath)\Output</OutputPath>
    <IntermediateOutputPath>$(OutputPath)\obj</IntermediateOutputPath>
  </PropertyGroup>

  <!--
  Extract the KSP dll from the zips stored in BuildRelease\KSPReferenceZips
  A $(KSPVersion) property formated "X.X.X" must be given
  Call this with the following task to extract the KSP zips :

      <MSBuild
        Projects="myproject.csproj"
        Properties="KSPVersion=1.7.3"
        Targets="ExtractKSPDlls"/>
  -->
  <Target Name="ExtractKSPDlls">

    <ConvertToAbsolutePath Paths="$(KerbalismBuildPath)\KSPReferenceZips\KSP-$(KSPVersion).7z">
      <Output TaskParameter="AbsolutePaths" PropertyName="ZipAbsolutePath" />
    </ConvertToAbsolutePath>
    <ConvertToAbsolutePath Paths="$(KerbalismBuildPath)\Utility\7za.exe">
      <Output TaskParameter="AbsolutePaths" PropertyName="ZaWinAbsolutePath" />
    </ConvertToAbsolutePath>
    <ConvertToAbsolutePath Paths="$(KerbalismBuildPath)\KSPReferenceDlls">
      <Output TaskParameter="AbsolutePaths" PropertyName="OutputAbsolutePath" />
    </ConvertToAbsolutePath>

    <Message Text="Unzipping KSP $(KSPZip) dlls from $(ZipAbsolutePath) " Importance="high" />
    <Message Text="to $(OutputAbsolutePath)" Importance="high" />
    
    <RemoveDir Directories="$(OutputAbsolutePath)" />

    <Exec Condition="'$(OS)' == 'Windows_NT'" Command="$(ZaWinAbsolutePath) x $(ZipAbsolutePath) -o$(OutputAbsolutePath) -pgQn337XZBEFxzFuVwzKgc27ehZo7XLz485hh3erqF9 > nul" />
    <Exec Condition="'$(OS)' != 'Windows_NT'" Command="7za x $(ZipAbsolutePath) -o$(OutputAbsolutePath) -pgQn337XZBEFxzFuVwzKgc27ehZo7XLz485hh3erqF9" />

  </Target>
  
</Project>