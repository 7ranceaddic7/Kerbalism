// Note : we use wildcard ModuleDataTransmitter* matches in order to also
// catch mod-derivatives without having to duplicate the whole file.
// As of 01-2020, this is intended for NearFutureExploration support.

// Note on patch ordering :
// - If ModuleDataTransmitter modules are added or removed, it must be done before any zzzKerbalismDefault pass (:FOR[KerbalismDefault] is fine)
// - packetSize and packetResourceCost patches must be done in the :FOR[zzzKerbalismDefault] pass

// ============================================================================
// Global catch-all patch : nerf data rates
// ============================================================================
@PART[*]:HAS[@MODULE[ModuleDataTransmitter*]:HAS[~antennaType[INTERNAL],#antennaPower[>0]]]:NEEDS[FeatureScience,!RemoteTech]:BEFORE[zzzKerbalismDefault]
{
	// idea: nerf antennas based on antennaType at some point
	@MODULE[ModuleDataTransmitter*]
  {
    @packetSize /= #$packetInterval$
    @packetSize *= #$antennaPower$
    @packetSize /= 1000000
    @packetSize != 0.55
    %packetInterval = 1
  }
}

// ============================================================================
// Global catch-all patch : reduce EC consumption
// ============================================================================
@PART[*]:HAS[@MODULE[ModuleDataTransmitter*]:HAS[#antennaType[DIRECT]]]:NEEDS[!RemoteTech]:BEFORE[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter]:HAS[#antennaType[DIRECT]] { @packetResourceCost /= 1000}
}

@PART[*]:HAS[@MODULE[ModuleDataTransmitter*]:HAS[#antennaType[INTERNAL]]]:NEEDS[!RemoteTech]:BEFORE[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]:HAS[#antennaType[INTERNAL]] { @packetResourceCost /= 1000}
}

@PART[*]:HAS[@MODULE[ModuleDataTransmitter*]:HAS[#antennaType[RELAY]]]:NEEDS[!RemoteTech]:BEFORE[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]:HAS[#antennaType[RELAY]] { @packetResourceCost /= 500}
}

// ============================================================================
// per part tweaks
// packetSize is in Mb/s
// packetResourceCost is in EC/s
// ============================================================================

// Start: Communotron 8 (kerbalism-antenna)
@PART[kerbalism-antenna]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.0015
		%packetResourceCost = 0.012
	}
}

// T1: Communotron 16
@PART[longAntenna]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.0022
		%packetResourceCost = 0.020
	}
}

// T1: Communotron 16-S
@PART[SurfAntenna]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.0022
		%packetResourceCost = 0.020
	}
}

// T3: HG-5 High Gain Relay Antenna
@PART[HighGainAntenna5]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.0045
		%packetResourceCost = 0.080
	}
}

// T5: Communotron DTS-M1
@PART[mediumDishAntenna]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.025
		%packetResourceCost = 0.055
	}
}

// T5: RA-2 Relay Antenna
@PART[RelayAntenna5]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.018
		%packetResourceCost = 0.100
	}
}

// T6: RA-15 Relay Antenna
@PART[RelayAntenna50]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.165
		%packetResourceCost = 0.250
	}
}

// T6: Communotron HG-55
@PART[HighGainAntenna]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.200
		%packetResourceCost = 0.125
	}
}

// T7: Communotron 88-88
@PART[commDish]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.520
		%packetResourceCost = 0.45
	}
}

// T7: RA-100 Relay Antenna
@PART[RelayAntenna100]:NEEDS[FeatureScience,!RemoteTech]:FOR[zzzKerbalismDefault]
{
	@MODULE[ModuleDataTransmitter*]
	{
		%packetSize = 0.480
		%packetResourceCost = 0.75
	}
}
