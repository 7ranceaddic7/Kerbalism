// ============================================================================
// Kerbalism changes to stock science
// ============================================================================

@KERBALISM_SCIENCE_VALUES:NEEDS[KerbalismScience]
{
	crewReport
	{
		ECCost = 0.01
		size = 0.2
		value = 3
		duration = 270
	}

	evaReport
	{
		ECCost = 0.02
		size = 0.25
		value = 10
		duration = 45
	}

	surfaceSample
	{
		ECCost = 0.06
		size = 986								//large size to account for lab processing time.
		value = 22								//nerfed science value (40->22), removed oceanic samples due to dedicated experiment added
		duration = 40							//picking up some rocks is probably reasonably quick.
	}

	mysteryGoo
	{
		ECCost = 0.18
		size = 429								//same as above, massive data scale for lab processing.
		value = 6							  	// nerfed (13->6), also nuked biome mask (makes no sense that the samples would be different)
		duration = 641
    samples = 1
	}

	mobileMaterialsLab
	{
		ECCost = 2.04
		size = 3084
		value = 18								//value nerfed (32->18), nuked biome mask (makes no sense that the sampes would be different)
		duration = 1246						//20-ish min. (low duration due to aids with manually flying in atmo)
    samples = 1
	}

	temperatureScan
	{
		ECCost = 0.002						//all sensors will have very low EC/s consumption
		size = 0.45								//reasonably small scale, as it's a very early experiment
		value = 3									//nerfed value (8->3) due to it being an early unlock, left biome/situations unchanged
		duration = 138
	}

	barometerScan
	{
		ECCost = 0.05
		size = 3.5	  					  // you have to "steram" your first barometer scans
		value = 9									// nerfed value (12->9), changed situations to atmo/landed/splashed, biome masks landed/splashed/flying low, made it require atmosphere in all cases. (there's no pressure if there's no atmosphere, i'm sorry)
		duration = 916						//15 minutes+
	}

	seismicScan
	{
		ECCost = 0.0076
		size = 200
		value = 12								// nerfed value (22-12), left situations/biomes unchanged
		duration = 317248					// first moderately long-term experiment, 2 weeks+ required.
	}

	gravityScan
	{
		ECCost = 0.041
		size = 26014
		value = 16								// nerfed value, (22->16)
		duration = 1959086				//first properly long experiment, takes 90+ days to complete. Situations unchanged, biomes = landed/splashed only.
	}

	atmosphereAnalysis
	{
		ECCost = 2.84
		size = 6724								// long lab analysis for the sample.
		value = 16								// nerfed value (24->16). Removed biome mask for flying high. (i doubt the atmo has biome specific composition that high up)
		duration = 18							// quick experiment, but it's a sample, therefore requires lab analysis. the analysis will be long.
	}

	asteroidSample							//the only change that takes effect is size and value
	{
		size = 1694								// long lab analysis for the sample.
		value = 35								// biome should be irrelevant, asteroids don't have biomes, and flying above a planet's biome should also be irrelevant for the sample.
	}

	infraredTelescope
	{
		ECCost = 1.91
		size = 289386462					// humongous data scale, reasons below.
		value = 600								// massive value (reason below), limited to high orbit only.
		duration = 230083200			// 12. yes. 12. (years if it's unclear). Hubble has been operating for close to 30 years at this point, and still provides invaluable data. This should serve the same function in KSP
	}
}


// =============================================================================
// Add the Kerbalism extensions to stock experiments
// =============================================================================

@EXPERIMENT_DEFINITION:HAS[#id[surfaceSample]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/surfaceSample/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/surfaceSample/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = SrfLanded@Biomes
    SampleMass = 0.025
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[crewReport]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/crewReport/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/crewReport/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = Surface@Biomes
    Situation = FlyingLow
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[evaReport]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/evaReport/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/evaReport/size$
	@dataScale /= #$baseValue$

	KERBALISM_EXPERIMENT
	{
    Situation = Surface@Biomes
    Situation = InSpaceLow
    Situation = InSpaceHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[mysteryGoo]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/mysteryGoo/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/mysteryGoo/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    SampleMass = 0.0073
    Situation = SrfLanded
    Situation = SrfSplashed
    Situation = FlyingLow
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[mobileMaterialsLab]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/mobileMaterialsLab/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/mobileMaterialsLab/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    SampleMass = 0.032
    Situation = SrfLanded
    Situation = SrfSplashed
    Situation = FlyingLow
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[temperatureScan]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/temperatureScan/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/temperatureScan/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = Surface@Biomes
    Situation = FlyingLow@Biomes
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[barometerScan]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/barometerScan/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/barometerScan/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = Surface@Biomes
    Situation = FlyingLow@Biomes
    Situation = FlyingHigh
    BodyAllowed = Atmospheric
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[seismicScan]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/seismicScan/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/seismicScan/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = SrfLanded@Biomes
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[gravityScan]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/gravityScan/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/gravityScan/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = Surface@Biomes
    Situation = InSpaceLow
    Situation = InSpaceHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[atmosphereAnalysis]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/atmosphereAnalysis/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/atmosphereAnalysis/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = Surface@Biomes
    Situation = FlyingLow@Biomes
    Situation = FlyingHigh
    BodyAllowed = Atmospheric
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[asteroidSample]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/asteroidSample/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/asteroidSample/size$
	@dataScale /= #$baseValue$

  // note : we use the stock ModuleAsteroid experiment that we patch at runtime, the sample mass
  // is defined globally in settings.cfg
  KERBALISM_EXPERIMENT
	{
    Situation = SrfLanded@Biomes
    Situation = SrfSplashed@Biomes
    Situation = FlyingLow@Biomes
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[infraredTelescope]]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_SCIENCE_VALUES/infraredTelescope/value$
	@dataScale = #$@KERBALISM_SCIENCE_VALUES/infraredTelescope/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = InSpaceHigh
    BodyAllowed = HomeBody
	}
}

// ============================================================================
// Replacing stock experiments with our own, one by one.
// Affects all parts that use both the stock module AND stock experiments.
// ============================================================================
@PART[*]:HAS[@MODULE:HAS[#experimentID[atmosphereAnalysis]]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[atmosphereAnalysis]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = atmosphereAnalysis
	}
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[mysteryGoo]]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[mysteryGoo]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = mysteryGoo
	}
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[mobileMaterialsLab]]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[mobileMaterialsLab]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = mobileMaterialsLab
	}
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[seismicScan]]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[seismicScan]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = seismicScan
	}
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[barometerScan]]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[barometerScan]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = barometerScan
	}
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[gravityScan]]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[gravityScan]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = gravityScan
	}
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[temperatureScan]]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[temperatureScan]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = temperatureScan
	}
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[infraredTelescope]]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[infraredTelescope]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = infraredTelescope
	}
}
@PART[kerbalEVA*]:HAS[@MODULE[ModuleTripLogger]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[surfaceSample]]	{}
	!MODULE:HAS[#experimentID[evaReport]]		{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = surfaceSample
	}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = evaReport
	}
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[crewReport]]]:NEEDS[KerbalismScience]
{
	!MODULE:HAS[#experimentID[crewReport]]	{}
	MODULE
	{
		name = ModuleKsmExperiment
		experiment_id = crewReport
	}
}

// ============================================================================
// Reconfigure stock experiments (avoiding a global nuke to keep people happy)
// strongly recommended to not change anything in this section
// ============================================================================
@PART[*]:HAS[@MODULE[ModuleKsmExperiment]]:NEEDS[KerbalismScience]:FOR[Kerbalism]
{
	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[crewReport]]
	{
		%experiment_description = A brief situation report of dubious relevance and accuracy.
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/crewReport/ECCost$
		%crew_operate = True
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/crewReport/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/crewReport/duration$
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[surfaceSample]]
	{
		%sample_collecting = True
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/surfaceSample/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/surfaceSample/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/surfaceSample/duration$
		%hide_when_unavailable = true
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[evaReport]]
	{
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/evaReport/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/evaReport/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/evaReport/duration$
		%crew_operate = True
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[mysteryGoo]]
	{
		%sample_amount = #$@KERBALISM_SCIENCE_VALUES/mysteryGoo/samples$
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/mysteryGoo/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/mysteryGoo/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/mysteryGoo/duration$
    %allow_shrouded = False
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[mobileMaterialsLab]]
	{
		%sample_amount = #$@KERBALISM_SCIENCE_VALUES/mobileMaterialsLab/samples$
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/mobileMaterialsLab/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/mobileMaterialsLab/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/mobileMaterialsLab/duration$
    %allow_shrouded = False
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[temperatureScan]]
	{
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/temperatureScan/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/temperatureScan/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/temperatureScan/duration$
    %allow_shrouded = False
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[barometerScan]]
	{
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/barometerScan/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/barometerScan/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/barometerScan/duration$
		%allow_shrouded = False
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[seismicScan]]
	{
		%requires = Surface
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/seismicScan/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/seismicScan/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/seismicScan/duration$
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[gravityScan]]
	{
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/gravityScan/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/gravityScan/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/gravityScan/duration$
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[atmosphereAnalysis]]
	{
		%sample_collecting = True
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/atmosphereAnalysis/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/atmosphereAnalysis/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/atmosphereAnalysis/duration$
		%allow_shrouded = False
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[infraredTelescope]]
	{
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/infraredTelescope/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/infraredTelescope/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/infraredTelescope/duration$
    %allow_shrouded = False
	}

	@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[geigerCounter]]
	{
		%ec_rate = #$@KERBALISM_SCIENCE_VALUES/GeigerCounter/ECCost$
		%data_rate = #$@KERBALISM_SCIENCE_VALUES/GeigerCounter/size$
		@data_rate /= #$@KERBALISM_SCIENCE_VALUES/GeigerCounter/duration$
    %allow_shrouded = False
	}
}

// ============================================================================
// Animation fix for goo container & materials bay
// ============================================================================
@PART[GooExperiment,science_module]:NEEDS[KerbalismScience]:AFTER[Kerbalism]
{
	!MODULE[ModuleAnimateGeneric]		{}
	@MODULE[ModuleKsmExperiment]
	{
		%anim_deploy = Deploy
	}
}

// ============================================================================
// Remove scientist bonus
// ============================================================================
@EXPERIENCE_TRAIT[Scientist]:NEEDS[KerbalismScience]
{
	@desc = Scientists can reset experiments.
	@EFFECT[VesselScienceReturn] { @modifiers = 1, 1, 1, 1, 1 }
	@EFFECT[PartScienceReturn]   { @modifiers = 1, 1, 1, 1, 1 }
}

// ======================================================================
// adds sensors to gravioli/radiation/temperature/pressure to all parts that use
// the stock experiments and do not already have one.
// ============================================================================

@PART[*]:HAS[!MODULE[Sensor]:HAS[#type[radiation]],@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[geigerCounter]]]:NEEDS[KerbalismScience]:FOR[zzzKerbalism]
{
	!MODULE[ModuleEnviroSensor] {}
	MODULE
	{
		name = Sensor
		type = radiation
	}
}
@PART[*]:HAS[!MODULE[Sensor]:HAS[#type[gravioli]],@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[gravityScan]]]:NEEDS[KerbalismScience]:FOR[zzzKerbalism]
{
	!MODULE[ModuleEnviroSensor] {}
	MODULE
	{
		name = Sensor
		type = gravioli
	}
}
@PART[*]:HAS[!MODULE[Sensor]:HAS[#type[temperature]],@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[temperatureScan]]]:NEEDS[KerbalismScience]:FOR[zzzKerbalism]
{
	!MODULE[ModuleEnviroSensor] {}
	MODULE
	{
		name = Sensor
		type = temperature
	}
}
@PART[*]:HAS[!MODULE[Sensor]:HAS[#type[pressure]],@MODULE[ModuleKsmExperiment]:HAS[#experiment_id[barometerScan]]]:NEEDS[KerbalismScience]:FOR[zzzKerbalism]
{
	!MODULE[ModuleEnviroSensor] {}
	MODULE
	{
		name = Sensor
		type = pressure
	}
}
