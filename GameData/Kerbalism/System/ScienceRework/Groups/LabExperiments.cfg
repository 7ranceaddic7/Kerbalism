// ============================================================================
// Patching the laboratories, applying the group, and patching the SETUPs
// and the experiments based on values from KERBALISM_GROUP_SETTINGS
// ============================================================================
// Adding the relevant experiment modules
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	MODULE
	{
		name = Experiment
		experiment_id = mobileMaterialsLab
	}
	MODULE
	{
		name = Experiment
		experiment_id = mysteryGoo
	}		
	MODULE
	{
		name = Experiment
		experiment_id = kerbalism_CHILLED
	}
	MODULE
	{
		name = Experiment
		experiment_id = kerbalism_RELAX
	}	
	MODULE
	{
		name = Experiment
		experiment_id = kerbalism_Lab3
	}
	MODULE
	{
		name = Experiment
		experiment_id = kerbalism_Lab4
	}
	MODULE
	{
		name = Experiment
		experiment_id = kerbalism_Lab5
	}	
	MODULE
	{
		name = Experiment
		experiment_id = kerbalism_Lab6
	}

// ============================================================================
// Adding the Configure module to handle the experiment selection, together with
// the corresponding setups.	
	@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]
	{
		@slots = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BaseSlots$
		reconfigure = false
		
		UPGRADES
		{
			UPGRADE
			{
				name__ = LAB-Upgrade1
				techRequired__ = #$../../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/UpgradeTech$
				slots = whatever
				@slots = #$../../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/UpgradedSlots$
			}
			UPGRADE
			{
				name__ = LAB-Upgrade2
				techRequired__ = #$../../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/ReconfigureTech$
				reconfigure = #$../../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/ReconfigureRequirement$
			}
		}
		SETUP
		{
			name = None
			desc = Empty slot for mass and cost savings, should you not require any experiments installed.
		}					
		SETUP
		{
			name = Materials Bay Study
			desc = Install a SC-9001 Science Jr. Materials Bay in the Laboratory, allowing on-board scientists to study the behaviour of materials in different environments.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = mobileMaterialsLab
			}
		} 
		SETUP
		{
			name = Mystery Goo Observation
			desc = Install a Mystery Goo Containment Unit in the Laboratory, allowing on-board scientists to study the behaviour of the Goo in different environments.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = mysteryGoo
			}
		} 
		SETUP
		{
			name = CHILLED
			desc = Chlorophyl Horticulture In Lived Laboratory Experimental Determinations:  Scientists will spend time watching grass grow for science.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = kerbalism_CHILLED
			}
		}
		SETUP
		{
			name = RELAX
			desc = Regolith Experiential Laboratory Analysis eXplanation:  Scientists will spend time developing a meaningful relationship with the local regolith.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = kerbalism_RELAX
			}
		}
		SETUP
		{
			name = Lab3 Placeholder				
			desc = Lab3 Placeholder Description. (low orbit only, 18 months, no biomes. says 9, but shadow requirement, thus 18)
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = kerbalism_Lab3
			}
		}
		SETUP
		{
			name = Lab4 Placeholder				
			desc = Lab4 Placeholder Description. (ultra long term, 2+years. landed, for ground bases. no biomes)
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = kerbalism_Lab4
			}
		}
		SETUP
		{
			name = Lab5 Placeholder				
			desc = Lab5 Placeholder Description. (underwater, 4 months. because reasons. biomes)
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = kerbalism_Lab5
			}
		}
		SETUP
		{
			name = Lab6 Placeholder				
			desc = Lab6 Placeholder Description. (Atmo! Flying high/low. Flying Low biomes.)
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = kerbalism_Lab6
			}
		}		
	}
}
// ============================================================================
// the experiments were just added above, but not configured. This section takes care of that

@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_CHILLED]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/ResourceRates$
	}
	
	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_RELAX]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/ResourceRates$
		%sample_mass = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/SampleMass$
		%sample_collecting = True
	}

	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_Lab3]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/ResourceRates$
	}

	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_Lab4]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/ResourceRates$
		%sample_mass = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/SampleMass$
		%sample_collecting = True
	}
	
	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_Lab5]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/ResourceRates$
		%sample_mass = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/SampleMass$
		%sample_collecting = True
	}
	
	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_Lab6]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/ResourceRates$
	}
	
	@MODULE[Experiment]:HAS[#experiment_id[mobileMaterialsLab]]
	{
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/mobileMaterialsLab/CrewRequirement$
	}
	
	@MODULE[Experiment]:HAS[#experiment_id[mysteryGoo]]
	{
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/mysteryGoo/CrewRequirement$
	}
}

// ============================================================================
// Patching the Experiment Definitions, according to the values in KERBALISM_GROUP_SETTINGS
// ============================================================================

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_CHILLED]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_RELAX]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_Lab3]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_Lab4]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_Lab5]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_Lab6]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/size$
	@dataScale /= #$baseValue$
}

// ============================================================================
// Patching the SETUPs inside the Configure Module.
// ============================================================================
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]
	{
		@SETUP:HAS[#name[CHILLED]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_CHILLED/SetupCost$
		}
		
		@SETUP:HAS[#name[RELAX]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_RELAX/SetupCost$
		}
		
		@SETUP:HAS[#name[Lab3?Placeholder]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab3/SetupCost$
		}
		
		@SETUP:HAS[#name[Lab4?Placeholder]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab4/SetupCost$
		}
		
		@SETUP:HAS[#name[Lab5?Placeholder]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab5/SetupCost$
		}
		
		@SETUP:HAS[#name[Lab6?Placeholder]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/kerbalism_Lab6/SetupCost$
		}

		@SETUP:HAS[#name[Materials?Bay?Study]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/mobileMaterialsLab/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/mobileMaterialsLab/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/mobileMaterialsLab/SetupCost$
		}

		@SETUP:HAS[#name[Mystery?Goo?Observation]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/mysteryGoo/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/mysteryGoo/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/mysteryGoo/SetupCost$
		}		
	}
}
